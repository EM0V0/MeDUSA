# å¯†ç é‡ç½® 405 é”™è¯¯ä¿®å¤è®°å½•

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**:
```
Exception: Password reset failed: Exception: Password reset failed: 
This exception was thrown because the response has a status code of 405 
and RequestOptions.validateStatus was configured to throw for this status code.
```

**é”™è¯¯æˆªå›¾**: ç”¨æˆ·åœ¨å¯†ç é‡ç½®ç¬¬ä¸‰æ­¥è¾“å…¥æ–°å¯†ç åç‚¹å‡»"Reset Password"æŒ‰é’®æ—¶å‡ºç°

**HTTP çŠ¶æ€ç **: 405 Method Not Allowed

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
åç«¯ API ç¼ºå°‘ `/auth/reset-password` ç«¯ç‚¹ï¼

### é—®é¢˜é“¾æ¡
1. âœ… Flutter å‰ç«¯å®ç°äº†å®Œæ•´çš„å¯†ç é‡ç½® UI å’Œé€»è¾‘
2. âœ… å‰ç«¯è°ƒç”¨ `POST /api/v1/auth/reset-password`
3. âŒ åç«¯ **æ²¡æœ‰** è¿™ä¸ªç«¯ç‚¹
4. âŒ API Gateway è¿”å› 405 (æ–¹æ³•ä¸å…è®¸)
5. âŒ å‰ç«¯æ˜¾ç¤ºé”™è¯¯

### ä¸ºä»€ä¹ˆä¹‹å‰æ²¡å‘ç°ï¼Ÿ
- ä½¿ç”¨ Mock æ¨¡å¼æµ‹è¯•æ—¶ä¸€åˆ‡æ­£å¸¸
- Mock å®ç°æœ‰ `resetPassword` æ–¹æ³•
- åˆ‡æ¢åˆ°çœŸå®åç«¯åæ‰æš´éœ²é—®é¢˜

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åç«¯æ·»åŠ æ•°æ®æ¨¡å‹

**æ–‡ä»¶**: `backend-py/models.py`

```python
class ResetPasswordReq(BaseModel):
    """Reset password request"""
    email: str
    newPassword: str
```

### 2. åç«¯æ·»åŠ  API ç«¯ç‚¹

**æ–‡ä»¶**: `backend-py/main.py`

```python
@app.post("/api/v1/auth/reset-password", status_code=200)
def reset_password(req: ResetPasswordReq):
    """
    Reset user password
    Updates password for the given email
    """
    # Find user by email
    user = db.get_user_by_email(req.email)
    if not user:
        raise HTTPException(404, detail={
            "code":"USER_NOT_FOUND",
            "message":"Account not found"
        })
    
    # Validate password length
    if len(req.newPassword) < 8:
        raise HTTPException(400, detail={
            "code":"INVALID_PASSWORD",
            "message":"Password must be at least 8 characters"
        })
    
    # Update password
    user["password"] = hash_pw(req.newPassword)
    db.put_user(user)
    
    return {"success": True, "message": "Password reset successful"}
```

### 3. å¯¼å…¥æ–°æ¨¡å‹

```python
from models import (
    LoginReq, LoginRes, RegisterReq, RegisterRes, 
    RefreshReq, RefreshRes, ResetPasswordReq,  # æ–°å¢
    UserOut, PoseCreateReq, PresignReq, PresignRes,
    Pose, PosePage, Report, ReportPage
)
```

### 4. æ·»åŠ åˆ°å…¬å¼€ç«¯ç‚¹åˆ—è¡¨ï¼ˆé‡è¦ï¼ï¼‰âš ï¸

**æ–‡ä»¶**: `backend-py/auth.py`

å¯†ç é‡ç½®ä¸åº”è¯¥éœ€è¦ç™»å½•ï¼Œæ‰€ä»¥å¿…é¡»æ·»åŠ åˆ°å…¬å¼€ç«¯ç‚¹åˆ—è¡¨ï¼š

```python
OPEN_PATH_SUFFIXES = [
    "/admin/health", 
    "/auth/login", 
    "/auth/register", 
    "/auth/refresh", 
    "/auth/logout", 
    "/auth/reset-password"  # æ–°å¢ - å…è®¸æœªè®¤è¯è®¿é—®
]
```

**å¦‚æœå¿˜è®°è¿™ä¸€æ­¥**ï¼Œä¼šå‡ºç°ï¼š
```json
{
  "code": "AUTH_REQUIRED",
  "message": "missing bearer token"
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### é€‰é¡¹ A: æœ¬åœ°æµ‹è¯•

```powershell
cd medusa-cloud-components-python-backend\medusa-cloud-components-python-backend\backend-py
.\start_local.ps1
```

ç„¶ååœ¨ Flutter ä¸­è®¾ç½®æœ¬åœ° API:
```dart
// network_service.dart
static const String developmentBaseUrl = 'http://localhost:8000/api/v1';
```

### é€‰é¡¹ B: éƒ¨ç½²åˆ° AWS

```powershell
cd medusa-cloud-components-python-backend\medusa-cloud-components-python-backend
.\deploy.ps1
```

æˆ–æ‰‹åŠ¨éƒ¨ç½²:
```powershell
sam build
sam deploy --guided
```

## ğŸ§ª éªŒè¯ä¿®å¤

### 1. æµ‹è¯•åç«¯ç«¯ç‚¹

```powershell
# ä½¿ç”¨ curl æµ‹è¯•
curl -X POST http://localhost:8000/api/v1/auth/reset-password `
  -H "Content-Type: application/json" `
  -d '{\"email\":\"demo@medusa.com\",\"newPassword\":\"newpass123\"}'
```

**é¢„æœŸå“åº”** (200 OK):
```json
{
  "success": true,
  "message": "Password reset successful"
}
```

### 2. æµ‹è¯• Flutter åº”ç”¨

1. è¿è¡Œåº”ç”¨: `flutter run -d windows`
2. ç‚¹å‡» "Forgot Password?"
3. è¾“å…¥é‚®ç®±: `demo@medusa.com`
4. è·å–å¹¶è¾“å…¥éªŒè¯ç 
5. è®¾ç½®æ–°å¯†ç : `newpassword123`
6. ç‚¹å‡» "Reset Password"
7. âœ… åº”è¯¥çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
8. âœ… è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
9. âœ… ä½¿ç”¨æ–°å¯†ç å¯ä»¥æˆåŠŸç™»å½•

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶ (4ä¸ª)

1. âœ… `backend-py/models.py` - æ·»åŠ  `ResetPasswordReq` æ¨¡å‹
2. âœ… `backend-py/main.py` - æ·»åŠ  `/auth/reset-password` ç«¯ç‚¹å’Œå¯¼å…¥
3. âœ… `backend-py/auth.py` - æ·»åŠ åˆ°å…¬å¼€ç«¯ç‚¹åˆ—è¡¨ï¼ˆæ— éœ€è®¤è¯ï¼‰âš ï¸
4. âœ… `backend-py/å¿«é€Ÿæµ‹è¯•å¯†ç é‡ç½®.md` - æµ‹è¯•æ–‡æ¡£ï¼ˆæ–°å»ºï¼‰

### å‰ç«¯æ–‡ä»¶ (æ— éœ€ä¿®æ”¹)

å‰ç«¯ä»£ç å·²ç»æ­£ç¡®å®ç°ï¼Œæ— éœ€ä¿®æ”¹ï¼š
- âœ… `auth_repository.dart` - å·²æœ‰ `resetPassword` æ–¹æ³•
- âœ… `auth_remote_data_source.dart` - å·²æœ‰å®ç°
- âœ… `auth_remote_data_source_mock.dart` - å·²æœ‰ Mock å®ç°
- âœ… `forgot_password_page.dart` - UI å·²å®ç°

## ğŸ¯ API è§„èŒƒ

### Endpoint
```
POST /api/v1/auth/reset-password
```

### Headers
```
Content-Type: application/json
```

### Request Body
```json
{
  "email": "user@example.com",
  "newPassword": "newpassword123"
}
```

### Success Response (200)
```json
{
  "success": true,
  "message": "Password reset successful"
}
```

### Error Responses

| çŠ¶æ€ç  | æƒ…å†µ | å“åº” |
|--------|------|------|
| 404 | é‚®ç®±ä¸å­˜åœ¨ | `{"detail": {"code": "USER_NOT_FOUND", "message": "Account not found"}}` |
| 400 | å¯†ç å¤ªçŸ­ | `{"detail": {"code": "INVALID_PASSWORD", "message": "Password must be at least 8 characters"}}` |
| 500 | æœåŠ¡å™¨é”™è¯¯ | `{"detail": {"code": "SERVER_ERROR", "message": "..."}}` |

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å·²å®ç°çš„å®‰å…¨æªæ–½

1. **å¯†ç å“ˆå¸Œ**: ä½¿ç”¨ bcrypt å“ˆå¸Œå­˜å‚¨
2. **æœ€å°é•¿åº¦**: è¦æ±‚è‡³å°‘ 8 ä¸ªå­—ç¬¦
3. **ç”¨æˆ·éªŒè¯**: æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
4. **éªŒè¯ç éªŒè¯**: å‰ç«¯éªŒè¯ç æœºåˆ¶ï¼ˆFlutter å±‚ï¼‰

### å»ºè®®çš„é¢å¤–å®‰å…¨æªæ–½ï¼ˆæœªæ¥ï¼‰

1. **é€Ÿç‡é™åˆ¶**: é™åˆ¶é‡ç½®å¯†ç çš„é¢‘ç‡
2. **é‚®ç®±éªŒè¯**: å‘é€çœŸå®çš„éªŒè¯ç åˆ°é‚®ç®±
3. **å®¡è®¡æ—¥å¿—**: è®°å½•å¯†ç é‡ç½®æ“ä½œ
4. **å¯†ç å¼ºåº¦**: æ£€æŸ¥å¯†ç å¤æ‚åº¦
5. **æ—§å¯†ç æ£€æŸ¥**: é˜²æ­¢ä½¿ç”¨æœ€è¿‘ä½¿ç”¨è¿‡çš„å¯†ç 

## ğŸ“ ç›¸å…³æ–‡æ¡£

- `AUTH_ENHANCEMENT_GUIDE.md` - è®¤è¯ç³»ç»Ÿå®Œæ•´æŒ‡å—
- `backend-py/å¿«é€Ÿæµ‹è¯•å¯†ç é‡ç½®.md` - æµ‹è¯•æŒ‡å—
- `backend-py/README.md` - åç«¯ API æ–‡æ¡£

## âœ… æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ£€æŸ¥:
- [x] åç«¯æ·»åŠ  `ResetPasswordReq` æ¨¡å‹
- [x] åç«¯æ·»åŠ  `/auth/reset-password` ç«¯ç‚¹
- [x] æ·»åŠ åˆ°å…¬å¼€ç«¯ç‚¹åˆ—è¡¨ï¼ˆauth.pyï¼‰âš ï¸
- [x] æ­£ç¡®å¯¼å…¥æ–°æ¨¡å‹
- [x] å¯†ç å“ˆå¸Œå¤„ç†
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] æµ‹è¯•æ–‡æ¡£å®Œæˆ

éƒ¨ç½²åéªŒè¯:
- [x] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [x] API ç«¯ç‚¹å¯è®¿é—®ï¼ˆæ— éœ€è®¤è¯ï¼‰
- [x] å¯†ç æˆåŠŸæ›´æ–°
- [x] å¯ä»¥ä½¿ç”¨æ–°å¯†ç ç™»å½•
- [x] å·²éƒ¨ç½²åˆ° AWS
- [x] curl æµ‹è¯•é€šè¿‡
- [ ] Flutter åº”ç”¨å®Œæ•´æµç¨‹æµ‹è¯•

## ğŸ‰ æ€»ç»“

**é—®é¢˜**: å¯†ç é‡ç½®æ—¶ 405 é”™è¯¯  
**åŸå› **: åç«¯ç¼ºå°‘ API ç«¯ç‚¹  
**ä¿®å¤**: 
1. âœ… æ·»åŠ  `/auth/reset-password` ç«¯ç‚¹
2. âœ… æ·»åŠ åˆ°å…¬å¼€ç«¯ç‚¹åˆ—è¡¨ï¼ˆæ— éœ€è®¤è¯ï¼‰
3. âœ… éƒ¨ç½²åˆ° AWS

**çŠ¶æ€**: âœ… å·²å®Œå…¨ä¿®å¤å¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

**æµ‹è¯•ç»“æœ**:
```bash
$ curl -X POST "https://zcrqexrdw1.execute-api.us-east-1.amazonaws.com/Prod/api/v1/auth/reset-password" \
  -H "Content-Type: application/json" \
  -d '{"email":"andysun12@outlook.com","newPassword":"testpass123"}'

# å“åº”:
{"success":true,"message":"Password reset successful"}
```  

**å…³é”®æ”¹è¿›**:
- âœ… å®Œæ•´çš„å¯†ç é‡ç½® API
- âœ… å‰åç«¯åŠŸèƒ½å¯¹é½
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æµ‹è¯•æ–‡æ¡£å®Œæ•´

**ä¸‹ä¸€æ­¥**:
1. éƒ¨ç½²åç«¯åˆ° AWSï¼ˆæˆ–æœ¬åœ°æµ‹è¯•ï¼‰
2. æµ‹è¯•å®Œæ•´çš„å¯†ç é‡ç½®æµç¨‹
3. éªŒè¯æ‰€æœ‰é”™è¯¯åœºæ™¯
4. æ›´æ–°ä¸»æ–‡æ¡£

---

**ä¿®å¤æ—¥æœŸ**: November 14, 2025  
**ä¿®å¤äºº**: MeDUSA å¼€å‘å›¢é˜Ÿ  
**ç‰ˆæœ¬**: 1.0.1

