# 设备池 + 动态绑定架构实现总结

## ✅ 已完成的工作

### 1. 架构设计
成功实现了**方案 A：设备池 + 动态绑定**架构，解决了原有设计的问题：
- **原问题**：设备在注册时就强制绑定到患者
- **新架构**：设备注册到共享池，通过会话（Session）动态绑定到患者

### 2. 数据库设计

#### Sessions 表（新增）
```yaml
表名: medusa-sessions-prod
主键: sessionId (HASH)
全局二级索引:
  - deviceId-index: 按设备查询会话
  - patientId-index: 按患者查询会话
  - status-index: 按状态查询会话
```

#### Devices 表（修改）
- **移除**: `patientId-index` 全局二级索引
- **新增字段**: `currentSessionId` - 当前活跃会话 ID
- **修改字段**: `patientId` 改为可选（仅用于个人设备）

### 3. 数据模型

#### Session 相关模型
```python
- SessionCreateReq: 创建会话请求
- SessionUpdateReq: 更新会话请求
- Session: 会话模型
- SessionWithDetails: 包含设备和患者详情的会话
- SessionPage: 会话列表响应
```

#### Device 模型更新
```python
class Device:
    patientId: Optional[str]  # 可选
    currentSessionId: Optional[str]  # 新增
```

### 4. 数据库操作 (db.py)

新增 10 个会话操作函数：
- `create_session()` - 创建会话
- `get_session()` - 获取会话
- `get_active_session_by_device()` - 获取设备的活跃会话
- `get_sessions_by_patient()` - 获取患者的所有会话
- `get_sessions_by_device()` - 获取设备的所有会话
- `get_active_sessions()` - 获取所有活跃会话
- `update_session()` - 更新会话
- `delete_session()` - 删除会话

修改：
- `get_devices_by_patient()` - 改用 scan + filter（因为移除了索引）

### 5. API 端点

#### 会话管理 API（5个端点）
1. **POST /api/v1/sessions** - 创建测量会话
   - 权限：Doctor, Admin
   - 功能：动态绑定设备到患者
   - 检查：设备是否存在、是否已被占用、患者是否存在

2. **GET /api/v1/sessions/{session_id}** - 获取会话详情
   - 权限：Patient（自己的）, Doctor（自己患者的）, Admin（所有）
   - 返回：包含设备和患者详情的完整会话信息

3. **POST /api/v1/sessions/{session_id}/end** - 结束会话
   - 权限：Doctor, Admin
   - 功能：标记会话完成，释放设备

4. **GET /api/v1/devices/{device_id}/current-session** - 获取设备当前会话
   - 权限：公开（供 Pi 设备轮询）
   - 功能：Pi 设备通过此端点知道为哪个患者采集数据

5. **GET /api/v1/sessions** - 获取会话列表
   - 权限：Doctor（自己患者的）, Admin（所有）
   - 支持按状态过滤

#### 设备 API 修改
- **POST /api/v1/devices** - 权限改为 Doctor/Admin（从 Patient）
- 设备注册时不再绑定患者（`patientId = None`）
- 所有设备端点支持 `currentSessionId` 字段

### 6. RBAC 实现
- Doctor 只能为自己的患者创建会话
- Doctor 只能结束自己创建的会话
- Patient 只能查看自己的会话
- Admin 可以查看和管理所有会话

### 7. 部署
- ✅ 成功部署到 AWS Lambda
- ✅ Sessions 表成功创建
- ✅ Devices 表成功更新（移除 patientId 索引）

## ⚠️ 当前状态

### 已验证功能
- ✅ Doctor 注册
- ✅ Patient 注册
- ✅ 设备注册到共享池（无患者绑定）

### 待调试功能
- ⏸️ 会话创建（返回 500 Internal Server Error）
- ⏸️ Pi 设备轮询当前会话
- ⏸️ 会话结束
- ⏸️ 同一设备绑定到不同患者

### 已知问题
**会话创建 API 返回 500 错误**
- 症状：`POST /api/v1/sessions` 返回 "Internal Server Error"
- 已排查：
  - ✅ DynamoDB 表和索引配置正确
  - ✅ 导入语句完整（`Key`, `Attr`）
  - ✅ datetime 序列化已修复
  - ✅ 患者档案检查已放宽
- 可能原因：
  - Lambda 运行时错误（需查看 CloudWatch 日志）
  - Session 模型序列化问题
  - DynamoDB 写入权限问题

## 🔧 调试步骤

### 1. 查看 Lambda 日志
```bash
aws logs tail /aws/lambda/medusa-api-v3 --follow
```

### 2. 本地测试会话创建
```python
# 在 backend-py/ 目录运行
python -c "
from main import app
from fastapi.testclient import TestClient
client = TestClient(app)
# 测试会话创建
"
```

### 3. 检查 DynamoDB 权限
确认 Lambda 函数有 `dynamodb:PutItem` 权限到 `SessionsTable`

### 4. 简化测试
先测试最简单的会话创建（移除所有检查）

## 📊 架构优势

### 相比原设计的改进
1. **灵活性**：同一设备可以被不同患者使用
2. **可追溯性**：完整的会话历史记录
3. **并发控制**：防止设备冲突
4. **审计日志**：谁在何时使用了哪个设备

### 工作流程
```
1. 医院购买 Pi 设备
2. Doctor 注册设备到系统（共享池）
3. Patient A 来就诊
4. Doctor 创建会话：绑定 Device #1 到 Patient A
5. Pi Device #1 轮询 API，得知为 Patient A 采集数据
6. 测量完成，Doctor 结束会话
7. Device #1 释放，可供其他患者使用
8. Patient B 来就诊
9. Doctor 创建会话：绑定 Device #1 到 Patient B
10. 循环...
```

## 📁 相关文件

### 后端
- `template.yaml` - AWS SAM 配置（Sessions 表定义）
- `backend-py/models.py` - 数据模型
- `backend-py/db.py` - 数据库操作
- `backend-py/main.py` - API 端点
- `backend-py/rbac.py` - 权限控制

### 测试
- `test_session_api.ps1` - 完整测试脚本

### 文档
- `设备池动态绑定实现总结.md` - 本文档

## 🎯 下一步

### 选项 A: 完成调试
1. 查看 CloudWatch 日志找到具体错误
2. 修复会话创建 API
3. 完成完整测试流程

### 选项 B: 前端集成
1. 在 Flutter 中实现会话管理 UI
2. 医生端：创建/结束会话
3. 患者端：查看自己的会话历史

### 选项 C: Pi 端集成
1. Pi 设备轮询 `/devices/{id}/current-session`
2. 根据会话信息采集数据
3. 上传数据时关联 sessionId

---

**实现时间**: 2025-11-14  
**实现者**: AI Assistant  
**状态**: 🟡 90% 完成（待调试会话创建）

