# MeDUSA Docker Compose - INSECURE Mode (Educational Only)
#
# ⚠️  WARNING: THIS CONFIGURATION IS FOR EDUCATIONAL PURPOSES ONLY!
# ⚠️  NEVER USE THIS IN PRODUCTION ENVIRONMENTS!
#
# This configuration allows disabling security features to demonstrate
# vulnerabilities and attack scenarios for educational purposes.
#
# Usage:
#   docker-compose -f docker-compose.insecure.yml up -d
#
# Environment: SECURITY_MODE=insecure

version: '3.8'

services:
  # =============================================================================
  # Backend API Service - INSECURE MODE
  # =============================================================================
  backend:
    build:
      context: ./backend/backend-py
      dockerfile: Dockerfile
    container_name: medusa-backend-insecure
    environment:
      # ⚠️ INSECURE MODE - Security features can be disabled
      - SECURITY_MODE=insecure
      - EDUCATIONAL_LOGGING=true
      
      # Authentication (weaker settings for demo)
      - JWT_SECRET=INSECURE_DEMO_SECRET_DO_NOT_USE_IN_PRODUCTION
      - JWT_EXPIRE_SECONDS=86400  # 24 hours (longer for demo)
      - REFRESH_TTL_SECONDS=2592000  # 30 days
      
      # Replay Protection (can be disabled)
      - HMAC_SECRET=INSECURE_DEMO_HMAC_DO_NOT_USE
      - NONCE_TTL_SECONDS=600  # 10 minutes (longer window)
      
      # AWS Configuration (LocalStack)
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=localstack
      - AWS_SECRET_ACCESS_KEY=localstack
      - AWS_ENDPOINT_URL=http://localstack:4566
      - DDB_TABLE_USERS=medusa-users-insecure
      - DDB_TABLE_DEVICES=medusa-devices-insecure
      - DDB_TABLE_SESSIONS=medusa-sessions-insecure
      - DDB_TABLE_NONCES=medusa-nonces-insecure
      - S3_BUCKET=medusa-data-insecure
      
      # Use in-memory storage
      - USE_MEMORY=true
      
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - medusa-insecure-network
    restart: unless-stopped
    labels:
      - "com.medusa.security=INSECURE"
      - "com.medusa.warning=FOR_EDUCATIONAL_USE_ONLY"

  # =============================================================================
  # LocalStack (AWS Services Emulator)
  # =============================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: medusa-localstack-insecure
    environment:
      - SERVICES=dynamodb,s3,secretsmanager
      - DEFAULT_REGION=us-east-1
      - EDGE_PORT=4566
    ports:
      - "4566:4566"
    volumes:
      - localstack-insecure-data:/var/lib/localstack
    networks:
      - medusa-insecure-network

  # =============================================================================
  # DynamoDB Admin (for inspecting data)
  # =============================================================================
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    container_name: medusa-dynamodb-admin-insecure
    environment:
      - DYNAMO_ENDPOINT=http://localstack:4566
    ports:
      - "8001:8001"
    depends_on:
      - localstack
    networks:
      - medusa-insecure-network

  # =============================================================================
  # Network Traffic Inspector (Wireshark Alternative)
  # =============================================================================
  tcpdump:
    image: kaazing/tcpdump
    container_name: medusa-tcpdump
    network_mode: "host"
    volumes:
      - ./captures:/captures
    command: -i any -w /captures/medusa.pcap
    profiles:
      - traffic-capture

networks:
  medusa-insecure-network:
    driver: bridge

volumes:
  localstack-insecure-data:

# =============================================================================
# ⚠️  EDUCATIONAL SCENARIOS ⚠️
# =============================================================================
#
# This insecure configuration enables the following attack demonstrations:
#
# SCENARIO 1: Password Cracking
# -----------------------------
# 1. Toggle PASSWORD_HASHING feature off via API
# 2. Register a new user
# 3. Query DynamoDB to see plaintext password
# 4. Demonstrate rainbow table attack
#
# SCENARIO 2: JWT Token Manipulation
# ----------------------------------
# 1. Decode a valid JWT (jwt.io)
# 2. Modify the payload (change role to admin)
# 3. Attempt request with modified token
# 4. Observe signature validation failure
#
# SCENARIO 3: IDOR Attack
# -----------------------
# 1. Login as Patient A (ID: usr_111)
# 2. Capture request to /api/v1/patients/usr_111/data
# 3. Modify to /api/v1/patients/usr_222/data
# 4. Observe 403 Forbidden (resource ownership)
#
# SCENARIO 4: Replay Attack
# -------------------------
# 1. Capture a POST request with nonce header
# 2. Replay the exact same request
# 3. Observe "Nonce already used" error
#
# SCENARIO 5: Brute Force Attempt
# -------------------------------
# 1. Attempt multiple login requests
# 2. Observe rate limiting (429 Too Many Requests)
# 3. Demonstrate account lockout protection
#
# =============================================================================
# API Endpoints for Feature Toggle (Admin Only)
# =============================================================================
#
# Toggle security feature:
# POST /api/v1/security/features/{feature_id}/toggle?enabled=false
#
# Available feature IDs:
# - password_hashing
# - password_complexity
# - jwt_authentication
# - mfa_totp
# - rbac
# - resource_ownership
# - tls_enforcement
# - replay_protection
# - audit_logging
# - input_validation
# - secure_storage
# - rate_limiting
#
# =============================================================================
