
>   Future<bool> connectAndPair(String deviceAddress) async {
      try {
        debugPrint('[WinBleWiFi] 馃殌 Starting connection and pairing for $deviceAddress');
        _lastError = null;
        
        // 1. Initialize
        await _winBle.initialize();
        
        // 2. Pair FIRST (before connecting)
        // CRITICAL: Must pair before connect to avoid "Operation already in progress" error
        // Connecting first triggers Windows auto-pairing which conflicts with manual pairing
        _setStatus('Pairing...');
        debugPrint('[WinBleWiFi] 馃攼 Starting pairing (BEFORE connection)');
        debugPrint('[WinBleWiFi] 馃攼 Windows PIN dialog will appear');
        debugPrint('[WinBleWiFi] 馃摫 Check Raspberry Pi OLED for 6-digit PIN');
        
        final paired = await _winBle.pairDevice(deviceAddress);
        if (!paired) {
          _lastError = 'Pairing failed - user may have cancelled';
          throw Exception(_lastError);
        }
        _isPaired = true;
        debugPrint('[WinBleWiFi] 鉁?Pairing successful');
  
        // 3. Connect (AFTER successful pairing)
        _setStatus('Connecting to device...');
        debugPrint('[WinBleWiFi] 馃攲 Connecting to paired device...');
        
        final connected = await _winBle.connect(deviceAddress);
        if (!connected) {
          _lastError = 'Failed to connect to device';
          throw Exception(_lastError);
        }
        _connectedDeviceAddress = deviceAddress;
        debugPrint('[WinBleWiFi] 鉁?Connected');
  
        // Small delay to ensure pairing is complete
        await Future.delayed(const Duration(milliseconds: 1000));
  
        // 4. Discover services
        _setStatus('Discovering services...');
        final services = await _winBle.discoverServices(deviceAddress);
        debugPrint('[WinBleWiFi] 馃攳 Discovered ${services.length} service(s)');
  
        // Debug: Print all discovered services
        debugPrint('[WinBleWiFi] 馃搵 Listing all discovered services:');
        for (var i = 0; i < services.length; i++) {
          // WinBle returns services as String UUIDs directly, not objects
          final uuid = services[i] as String;
          debugPrint('[WinBleWiFi]   Service $i: $uuid');
        }
        
        // Verify WiFi Helper service exists
        final targetUuid = SERVICE_UUID.toLowerCase().replaceAll('-', '');
        debugPrint('[WinBleWiFi] 馃攳 Looking for service UUID: $SERVICE_UUID');
        debugPrint('[WinBleWiFi] 馃攳 Normalized UUID: $targetUuid');
        
        final hasWiFiService = services.any((service) {
          // Service is already a String UUID
          final uuid = service as String;
          final normalizedUuid = uuid.toLowerCase().replaceAll('-', '');
          final matches = normalizedUuid == targetUuid;
          
          if (matches) {
            debugPrint('[WinBleWiFi]   鉁?MATCH FOUND: $uuid');
          }
          
          return matches;
        });
        
        if (!hasWiFiService) {
          _lastError = 'WiFi Helper service not found';
          debugPrint('[WinBleWiFi] 鉂?WiFi Helper service UUID not in discovered services!');
          debugPrint('[WinBleWiFi] 鉂?Expected: $SERVICE_UUID');
          debugPrint('[WinBleWiFi] 鉂?This likely means:');
          debugPrint('[WinBleWiFi]    1. Raspberry Pi GATT server is not running');
          debugPrint('[WinBleWiFi]    2. Service UUID mismatch');
          debugPrint('[WinBleWiFi]    3. Service requires higher permissions');
          throw Exception(_lastError);
        }
        debugPrint('[WinBleWiFi] 鉁?WiFi Helper service found');


