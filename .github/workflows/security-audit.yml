name: Security Audit & SBOM

on:
  push:
    branches: [ "main", "develop", "refactor/*" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * 0' # Weekly

permissions:
  contents: read
  security-events: write

jobs:
  security-check:
    name: ðŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # ---------------------------------------------------------
      # 1. Secret Scanning
      # ---------------------------------------------------------
      - name: Compute BASE commit
        id: base
        run: |
          if [[ -n "${{ github.event.before }}" ]] && [[ "${{ github.event.before }}" != "${{ github.sha }}" ]]; then
            echo "BASE=${{ github.event.before }}" >> $GITHUB_OUTPUT
          elif [[ $(git rev-list --count HEAD) -gt 1 ]]; then
            # Use previous commit only if it exists
            echo "BASE=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
          else
            # Fallback: use empty tree hash (scans the entire history)
            echo "BASE=4b825dc642cb6eb9a060e54bf8d69288fbee4904" >> $GITHUB_OUTPUT
          fi

      - name: TruffleHog OSS - Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.base.outputs.BASE }}
          head: ${{ github.sha }}
          extra_args: --only-verified
        continue-on-error: true 

      # ---------------------------------------------------------
      # 2. Backend Security (Python)
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Security Tools
        run: |
          pip install bandit safety
          
      - name: Bandit - SAST Scan (Backend)
        run: |
          # Recursive scan, skip B101 (assert), exclude vendored dependencies and test files
          # Additional exclusions: botocore, cffi, jmespath, pydantic, starlette, etc (framework/lib code)
          bandit -r lambda_functions/ -ll --skip B101 -x lambda_functions/package,lambda_functions/medusa-api-v3/anyio,lambda_functions/medusa-api-v3/pycparser,lambda_functions/medusa-api-v3/botocore,lambda_functions/medusa-api-v3/cffi,lambda_functions/medusa-api-v3/jmespath,lambda_functions/medusa-api-v3/jwt,lambda_functions/medusa-api-v3/pydantic,lambda_functions/medusa-api-v3/six.py,lambda_functions/medusa-api-v3/starlette,lambda_functions/medusa-api-v3/typing_extensions.py,lambda_functions/medusa-api-v3/typing_inspection,lambda_functions/medusa-api-v3/uvicorn

      - name: Safety - Dependency Scan
        run: |
          if [ -f lambda_functions/requirements.txt ]; then
            safety check -r lambda_functions/requirements.txt
          fi

      # ---------------------------------------------------------
      # 3. Frontend Security (Flutter)
      # ---------------------------------------------------------
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Flutter Dependencies & Audit
        working-directory: frontend
        run: |
          flutter pub get
          # Flutter 3.19+ has built-in audit, fallback if not available
          # flutter pub audit || echo "Audit command not available on this version"
          flutter analyze

  sbom-generation:
    name: ðŸ“¦ Generate SBOM
    runs-on: ubuntu-latest
    needs: security-check
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate SBOM (CycloneDX) - Backend
        uses: anchore/sbom-action@v0
        with:
          path: lambda_functions/
          format: cyclonedx-json
          output-file: medusa-backend-sbom.json

      - name: Generate SBOM (CycloneDX) - Frontend
        uses: anchore/sbom-action@v0
        with:
          path: frontend/
          format: cyclonedx-json
          output-file: medusa-frontend-sbom.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: Medusa-SBOMs
          path: |
            medusa-backend-sbom.json
            medusa-frontend-sbom.json
