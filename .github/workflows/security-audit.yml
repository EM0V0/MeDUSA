name: Security Audit & SBOM

on:
  push:
    branches: [ "main", "develop", "refactor/*" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * 0' # Weekly

permissions:
  contents: read
  security-events: write

jobs:
  security-check:
    name: ðŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # ---------------------------------------------------------
      # 1. Secret Scanning
      # ---------------------------------------------------------
      - name: Compute BASE commit
        id: base
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          elif [[ -n "${{ github.event.before }}" ]] && [[ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]] && [[ "${{ github.event.before }}" != "${{ github.sha }}" ]]; then
            echo "BASE=${{ github.event.before }}" >> $GITHUB_OUTPUT
          elif [[ $(git rev-list --count HEAD) -gt 1 ]]; then
            echo "BASE=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
          else
             # For initial commit or single commit history, scan from empty tree
             echo "BASE=4b825dc642cb6eb9a060e54bf8d69288fbee4904" >> $GITHUB_OUTPUT
          fi

      - name: TruffleHog OSS - Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.base.outputs.BASE }}
          head: ${{ github.sha }}
          extra_args: --only-verified
        continue-on-error: true 

      # ---------------------------------------------------------
      # 2. Backend Security (Python)
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Security Tools
        run: |
          pip install bandit safety
          
      - name: Bandit - SAST Scan (Backend)
        run: |
          # Recursive scan, skip B101 (assert), exclude virtual environment and test files
          bandit -r backend/backend-py/ -ll --skip B101 -x backend/backend-py/.venv,backend/backend-py/__pycache__

      - name: Safety - Dependency Scan
        run: |
          if [ -f backend/backend-py/requirements.txt ]; then
            safety check -r backend/backend-py/requirements.txt --ignore 70612
          fi

      # ---------------------------------------------------------
      # 3. Frontend Security (Flutter)
      # ---------------------------------------------------------
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Flutter Dependencies & Audit
        working-directory: frontend
        run: |
          flutter pub get
          # Flutter 3.19+ has built-in audit, fallback if not available
          # flutter pub audit || echo "Audit command not available on this version"
          flutter analyze --no-fatal-infos

  sbom-generation:
    name: ðŸ“¦ Generate SBOM
    runs-on: ubuntu-latest
    needs: security-check
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate SBOM (CycloneDX) - Backend
        uses: anchore/sbom-action@v0
        with:
          path: backend/backend-py/
          format: cyclonedx-json
          output-file: medusa-backend-sbom.json

      - name: Generate SBOM (CycloneDX) - Frontend
        uses: anchore/sbom-action@v0
        with:
          path: frontend/
          format: cyclonedx-json
          output-file: medusa-frontend-sbom.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: Medusa-SBOMs
          path: |
            medusa-backend-sbom.json
            medusa-frontend-sbom.json
