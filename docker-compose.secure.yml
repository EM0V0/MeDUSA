# MeDUSA Docker Compose - SECURE Mode (Production)
#
# This configuration runs MeDUSA with all security features enabled.
# Use this for production deployments or secure testing.
#
# Usage:
#   docker-compose -f docker-compose.secure.yml up -d
#
# Environment: SECURITY_MODE=secure

version: '3.8'

services:
  # =============================================================================
  # Backend API Service
  # =============================================================================
  backend:
    build:
      context: ./backend/backend-py
      dockerfile: Dockerfile
    container_name: medusa-backend-secure
    environment:
      # Security Mode: SECURE (all features enabled)
      - SECURITY_MODE=secure
      - EDUCATIONAL_LOGGING=false
      
      # Authentication
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRE_SECONDS=3600
      - REFRESH_TTL_SECONDS=604800
      
      # Replay Protection
      - HMAC_SECRET=${HMAC_SECRET:-${JWT_SECRET}}
      - NONCE_TTL_SECONDS=300
      
      # AWS Configuration (use LocalStack for local development)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-localstack}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-localstack}
      - DDB_TABLE_USERS=medusa-users-prod
      - DDB_TABLE_DEVICES=medusa-devices-prod
      - DDB_TABLE_SESSIONS=medusa-sessions-prod
      - DDB_TABLE_NONCES=medusa-nonces-prod
      - S3_BUCKET=medusa-data-prod
      
      # Use in-memory for local dev (set to false for real AWS)
      - USE_MEMORY=${USE_MEMORY:-true}
      
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - medusa-network
    restart: unless-stopped

  # =============================================================================
  # LocalStack (AWS Services Emulator for Development)
  # =============================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: medusa-localstack
    environment:
      - SERVICES=dynamodb,s3,secretsmanager
      - DEFAULT_REGION=us-east-1
      - EDGE_PORT=4566
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - medusa-network
    profiles:
      - local-dev

  # =============================================================================
  # DynamoDB Admin (Optional - for debugging)
  # =============================================================================
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    container_name: medusa-dynamodb-admin
    environment:
      - DYNAMO_ENDPOINT=http://localstack:4566
    ports:
      - "8001:8001"
    depends_on:
      - localstack
    networks:
      - medusa-network
    profiles:
      - local-dev

networks:
  medusa-network:
    driver: bridge

volumes:
  localstack-data:

# =============================================================================
# Security Notes for SECURE Mode
# =============================================================================
#
# 1. All 12 security features are ENABLED:
#    - Password Hashing (Argon2id)
#    - Password Complexity
#    - JWT Authentication
#    - MFA (TOTP)
#    - RBAC
#    - Resource Ownership
#    - TLS Enforcement
#    - Replay Protection
#    - Audit Logging
#    - Input Validation
#    - Secure Storage
#    - Rate Limiting
#
# 2. Required secrets (must be set via .env or environment):
#    - JWT_SECRET: 256-bit secret for JWT signing
#    - HMAC_SECRET: Secret for nonce HMAC (defaults to JWT_SECRET)
#
# 3. For production deployment:
#    - Set USE_MEMORY=false
#    - Configure real AWS credentials
#    - Enable TLS at load balancer level
#    - Review API Gateway rate limiting
#
# =============================================================================
