<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="600" viewBox="0 0 1000 600">
  <style>
    .box { fill:#f4f7fb; stroke:#2b6cb0; stroke-width:2px; }
    .box-secure { fill:#e8f5e9; stroke:#2e7d32; stroke-width:2px; }
    .box-storage { fill:#fff3e0; stroke:#ef6c00; stroke-width:2px; }
    .text { font-family: Arial, Helvetica, sans-serif; font-size:11px; fill:#0b2a4a }
    .title { font-weight:700; font-size:12px }
    .section-title { font-weight:700; font-size:14px; fill:#1565c0 }
    .arrow { stroke:#2b6cb0; stroke-width:2; marker-end: url(#arrowhead); }
    .arrow-secure { stroke:#2e7d32; stroke-width:2; stroke-dasharray:5,3; marker-end: url(#arrowhead-green); }
    .note { font-family: Arial, Helvetica, sans-serif; font-size:10px; fill:#666 }
    .trust-boundary { fill:none; stroke:#d32f2f; stroke-width:2; stroke-dasharray:8,4; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2b6cb0" />
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2e7d32" />
    </marker>
  </defs>

  <!-- Title -->
  <text class="section-title" x="400" y="25">MeDUSA System Data Flow Architecture</text>

  <!-- Trust Boundary 1: Device Zone -->
  <rect class="trust-boundary" x="15" y="40" width="200" height="200" rx="10" />
  <text class="note" x="25" y="55">Trust Boundary 1: Device Zone</text>

  <!-- Sensor Device -->
  <rect class="box" x="30" y="70" width="170" height="80" rx="6" />
  <text class="title" x="50" y="95">Wearable Sensor (Pi)</text>
  <text class="text" x="50" y="112">• IMU/Magnetometer</text>
  <text class="text" x="50" y="126">• Real-time tremor data</text>
  <text class="text" x="50" y="140">• WiFi → Cloud upload</text>

  <!-- Mobile/Desktop App -->
  <rect class="box" x="30" y="170" width="170" height="70" rx="6" />
  <text class="title" x="50" y="195">Flutter App</text>
  <text class="text" x="50" y="212">• BLE → WiFi provisioning</text>
  <text class="text" x="50" y="226">• Local secure storage</text>

  <!-- Trust Boundary 2: Network Zone -->
  <rect class="trust-boundary" x="230" y="40" width="280" height="510" rx="10" />
  <text class="note" x="240" y="55">Trust Boundary 2: AWS Cloud</text>

  <!-- API Gateway -->
  <rect class="box-secure" x="250" y="70" width="240" height="90" rx="6" />
  <text class="title" x="270" y="95">AWS API Gateway</text>
  <text class="text" x="270" y="112">• TLS 1.3 termination</text>
  <text class="text" x="270" y="126">• Rate limiting (100/min)</text>
  <text class="text" x="270" y="140">• CORS configuration</text>

  <!-- Lambda Authorizer -->
  <rect class="box-secure" x="250" y="175" width="240" height="70" rx="6" />
  <text class="title" x="270" y="195">Lambda Authorizer</text>
  <text class="text" x="270" y="212">• JWT validation (HS256)</text>
  <text class="text" x="270" y="226">• Role extraction</text>

  <!-- Main Lambda -->
  <rect class="box" x="250" y="260" width="240" height="120" rx="6" />
  <text class="title" x="270" y="285">Lambda: MeDUSA API</text>
  <text class="text" x="270" y="302">• FastAPI + Mangum</text>
  <text class="text" x="270" y="316">• RBAC enforcement</text>
  <text class="text" x="270" y="330">• Argon2id password hashing</text>
  <text class="text" x="270" y="344">• TOTP MFA verification</text>
  <text class="text" x="270" y="358">• Audit logging</text>

  <!-- Process Sensor Lambda -->
  <rect class="box" x="250" y="395" width="240" height="70" rx="6" />
  <text class="title" x="270" y="415">Lambda: ProcessSensorData</text>
  <text class="text" x="270" y="432">• Tremor analysis (FFT)</text>
  <text class="text" x="270" y="446">• Data normalization</text>

  <!-- SES -->
  <rect class="box" x="250" y="480" width="110" height="55" rx="6" />
  <text class="title" x="265" y="500">AWS SES</text>
  <text class="text" x="265" y="517">• Email service</text>

  <!-- Secrets Manager -->
  <rect class="box-secure" x="380" y="480" width="110" height="55" rx="6" />
  <text class="title" x="395" y="500">Secrets Mgr</text>
  <text class="text" x="395" y="517">• JWT secret</text>

  <!-- Trust Boundary 3: Data Zone -->
  <rect class="trust-boundary" x="525" y="40" width="460" height="510" rx="10" />
  <text class="note" x="535" y="55">Trust Boundary 3: Data Storage</text>

  <!-- DynamoDB Tables -->
  <rect class="box-storage" x="545" y="70" width="200" height="150" rx="6" />
  <text class="title" x="565" y="95">DynamoDB Tables</text>
  <text class="text" x="565" y="115">• medusa-users-prod</text>
  <text class="text" x="565" y="130">• medusa-devices-prod</text>
  <text class="text" x="565" y="145">• medusa-sessions-prod</text>
  <text class="text" x="565" y="160">• medusa-patient-profiles</text>
  <text class="text" x="565" y="175">• medusa-tremor-analysis</text>
  <text class="text" x="565" y="190">• medusa-sensor-data</text>
  <text class="text" x="565" y="205">Encryption at rest (AWS KMS)</text>

  <!-- S3 -->
  <rect class="box-storage" x="760" y="70" width="200" height="90" rx="6" />
  <text class="title" x="780" y="95">S3 Buckets</text>
  <text class="text" x="780" y="112">• medusa-firmware-prod</text>
  <text class="text" x="780" y="127">• medusa-reports-prod</text>
  <text class="text" x="780" y="142">Versioning + lifecycle rules</text>

  <!-- CloudWatch -->
  <rect class="box-storage" x="545" y="240" width="200" height="70" rx="6" />
  <text class="title" x="565" y="265">CloudWatch</text>
  <text class="text" x="565" y="282">• Audit logs</text>
  <text class="text" x="565" y="297">• Metrics &amp; alarms</text>

  <!-- Data Flow Legend -->
  <rect class="box" x="545" y="330" width="420" height="130" rx="6" />
  <text class="title" x="565" y="355">Data Flow Summary</text>
  <text class="text" x="565" y="375">1. App → Sensor: BLE WiFi provisioning</text>
  <text class="text" x="565" y="390">2. Sensor → API Gateway: WiFi/HTTPS/TLS 1.3</text>
  <text class="text" x="565" y="405">3. API Gateway → Lambda: JWT validation</text>
  <text class="text" x="565" y="420">4. Lambda → DynamoDB: IAM role auth</text>
  <text class="text" x="565" y="435">5. All data encrypted at rest (AWS managed)</text>

  <!-- Auth Flow -->
  <rect class="box-secure" x="545" y="475" width="420" height="70" rx="6" />
  <text class="title" x="565" y="495">Authentication Flow</text>
  <text class="text" x="565" y="512">Login → [Credentials valid?] → MFA Challenge → [TOTP valid?]</text>
  <text class="text" x="565" y="527">→ Issue JWT (1h access + 7d refresh) → Store refresh in DynamoDB</text>

  <!-- Arrows: App to Device (WiFi provisioning via BLE) -->
  <line class="arrow" x1="115" y1="170" x2="115" y2="150" />
  <text class="note" x="120" y="163">BLE WiFi</text>

  <!-- Arrows: Sensor direct to API Gateway (via WiFi) -->
  <line class="arrow-secure" x1="200" y1="105" x2="250" y2="105" />
  <text class="note" x="205" y="98">WiFi/TLS</text>

  <!-- Arrows: App to API Gateway -->
  <line class="arrow-secure" x1="200" y1="205" x2="250" y2="125" />
  <text class="note" x="205" y="160">TLS 1.3</text>

  <!-- Arrows: API Gateway to Authorizer -->
  <line class="arrow" x1="370" y1="160" x2="370" y2="175" />

  <!-- Arrows: Authorizer to Lambda -->
  <line class="arrow" x1="370" y1="245" x2="370" y2="260" />

  <!-- Arrows: Lambda to DynamoDB -->
  <line class="arrow" x1="490" y1="320" x2="545" y2="140" />

  <!-- Arrows: Lambda to S3 -->
  <line class="arrow" x1="490" y1="290" x2="760" y2="115" />

  <!-- Arrows: Lambda to SES -->
  <line class="arrow" x1="305" y1="380" x2="305" y2="480" />

  <!-- Arrows: Lambda to CloudWatch -->
  <line class="arrow" x1="490" y1="350" x2="545" y2="275" />

  <!-- Arrows: Process Lambda to DynamoDB -->
  <line class="arrow" x1="490" y1="430" x2="545" y2="175" />
</svg>